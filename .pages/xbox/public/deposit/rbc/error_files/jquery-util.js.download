/**
* This is a jquery extension library for Mobeix RBC web.
*
* @class jquery-util
* @author Rj
* @constructor
*/
$.extend({
	/**
 	* Returns the query string parameters into an object.
 	*
	* @method getUrlVars
	* @return {Boolean} object
	*/
	getUrlVars: function () {
		var vars = [], hash;
		var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
		for (var i = 0; i < hashes.length; i++) {
			hash = hashes[i].split('=');
			vars.push(hash[0]);
			vars[hash[0]] = hash[1];
		}
		return vars;
	},

	/**
	* Returns a particular query string parameter value.
	*
	* @method getUrlVar
	* @param {String} query string parameter name
	* @return {Boolean} parameter value
	*/
	getUrlVar: function (name) {
		return $.getUrlVars()[name];
	},

	/**
	* Redirects to OLB e-Transfer
	*
	* @method redirectToOLBeTransfer
	*/
	redirectToOLBeTransfer: function (lang) {
		var iemtRefNo = $.getUrlVar('iemt');
		//var lang = $.getUrlVar('lang');
		var language = (lang == 'fr' || lang == 'FR') ? 'FRENCH' : 'ENGLISH';
		var ist = $.getUrlVar('ist');
		if (ist == 'Y')
			window.location = 'https://www1.steroyalbank.com/cgi-bin/rbaccess/rbunxcgi?F6=1&F7=IB&F21=IB&F22=IB&REQUEST=ClientSignin&LANGUAGE=' + language + '&GOTO=EMTAuth&PARM1=' + iemtRefNo;
		else
			window.location = 'https://www1.royalbank.com/cgi-bin/rbaccess/rbunxcgi?F6=1&F7=IB&F21=IB&F22=IB&REQUEST=ClientSignin&LANGUAGE=' + language + '&GOTO=EMTAuth&PARM1=' + iemtRefNo;
	},

	/**
	* Redirects to OLB for Lock
	*
	* @method redirectToOLBLock
	*/
	redirectToOLBLock: function (lang) {
		var state = $.getUrlVar('state');
		var scope = $.getUrlVar('scope');
		var responseType = $.getUrlVar('response_type');
		var clientId = $.getUrlVar('client_id');
		var redirectURI = $.getUrlVar('redirect_uri');
		var requestOb = $.getUrlVar('request');
		var acrValues = $.getUrlVar('acr_values');
		var language = (lang == 'fr' || lang == 'FR') ? 'FRENCH' : 'ENGLISH';
		var goTo = $.getUrlVar('goTo');

		window.location = "${lock.olb_url}" + language + "&IDP=VME"
			+ "&redirect_uri=" + redirectURI
			+ "&vmrequest=" + requestOb
			+ "&state=" + state
			+ "&scope=" + scope
			+ "&response_type=" + responseType
			+ "&client_id=" + clientId
			+ "&acr_values=" + acrValues
			+ ((goTo === undefined) ? "" : "&goTo=" + goTo);
	},

	/**
	* Redirects to App store
	*
	* @method redirectToAppStore
	*/
	redirectToAppStore: function () {
		var platform = $.getUrlVar('platform');
		var tab = $.getUrlVar('tab');

		if (platform == "AN") {
			window.location = "https://play.google.com/store/apps/details?id=com.rbc.mobile.android";
		} 
		else if (platform == "IP") {
			if (tab == 'Y')
				window.location = "https://itunes.apple.com/ca/app/rbc-canada/id552005862?mt=8";
			else
				window.location = "https://itunes.apple.com/ca/app/rbc-mobile/id407597290?mt=8";
		} 
		else {
			window.location = "http://www.rbcroyalbank.com";
		}
	},

	/**
	* Redirects to referrer
	*
	* @method redirectToReferrer
	*/
	redirectToReferrer: function (lang) {
		var referrer = $.getUrlVar('ref');
		if (referrer != null && referrer != "" && referrer != "null") {
			window.location = decodeURIComponent(referrer);
		} else {
			$.redirectToOLBeTransfer(lang)
		}
	},

	/**
	* Redirects to redirectToDownload
	*
	* @method redirectToDownload
	*/
	redirectToDownload: function () {
		var platform = $.getUrlVar('platform');
		var lang = $.getUrlVar('lang');
		var ist = $.getUrlVar('ist');
		var istURL = ist == "Y" ? "&ist=Y" : "";
		var encodedReferrer = $.getUrlVar('ref');
		var referrerURL = encodedReferrer != null && encodedReferrer != "" ? "&ref=" + encodedReferrer : "";
		var encodedRefNo = $.getUrlVar('iemt');
		if (lang == 'fr' || lang == 'FR') {
			window.location = "/mb/mxweb/rbc/download-fr.html?platform=AN&lang=" + lang + istURL + referrerURL + "&iemt=" + encodedRefNo;
		} else {
			window.location = "/mb/mxweb/rbc/download-en.html?platform=AN&lang=" + lang + istURL + referrerURL + "&iemt=" + encodedRefNo;
		}
	},

	/**
	  * Launch IPhone App if already installed
	  *
	  * @method launchIPhoneApp
	  */
	launchIPhoneApp: function () {
		var platform = $.getUrlVar('platform');
		var lang = $.getUrlVar('lang');
		var ist = $.getUrlVar('ist');
		var istURL = ist == "Y" ? "&ist=Y" : "";
		var encodedReferrer = $.getUrlVar('ref');
		var referrerURL = encodedReferrer != null && encodedReferrer != "" ? "&ref=" + encodedReferrer : "";
		var encodedRefNo = $.getUrlVar('iemt');

		var tab = $.getUrlVar('tab');

		window.location = "rbcmobile://iemt_" + encodedRefNo;
	},

	/**
	  * Launch IPhone App with Lock parameters if already installed
	  *
	  * @method launchIPhoneAppLock
	  */
	launchIPhoneAppLock: function () {
		var state = $.getUrlVar('state');
		var scope = $.getUrlVar('scope');
		var responseType = $.getUrlVar('response_type');
		var clientId = $.getUrlVar('client_id');
		var redirectURI = $.getUrlVar('redirect_uri');
		var requestOb = $.getUrlVar('request');
		var acrValues = $.getUrlVar('acr_values');
		var goTo = $.getUrlVar('goTo');
		var url;

		if (goTo === 'profile') {
			url = "rbcmobilevme://profile";
		}
		else {
			url = "rbcmobilevme://verify";
		}

		window.location = url
			+ "?redirect_uri=" + redirectURI
			+ "&request=" + requestOb
			+ "&state=" + state
			+ "&scope=" + scope
			+ "&response_type=" + responseType
			+ "&client_id=" + clientId
			+ "&acr_values=" + acrValues;
	},

	/**
	  * Launch Android App if already installed
	  *
	  * @method launchAndroidApp
	  */
	launchAndroidApp: function () {
		var platform = $.getUrlVar('platform');
		var lang = $.getUrlVar('lang');
		var ist = $.getUrlVar('ist');
		var istURL = ist == "Y" ? "&ist=Y" : "";
		var encodedReferrer = $.getUrlVar('ref');
		var referrerURL = encodedReferrer != null && encodedReferrer != "" ? "&ref=" + encodedReferrer : "";
		var encodedRefNo = $.getUrlVar('iemt');

		window.parent.location = "intent://rbcbanking?iemt=" + encodedRefNo + "#Intent;scheme=rbcbanking;package=com.rbc.mobile.android;end";
	},

	/**
	  * Launch Android App with Lock parameters if already installed
	  *
	  * @method launchAndroidAppLock
	  */
	launchAndroidAppLock: function () {
		var state = $.getUrlVar('state');
		var scope = $.getUrlVar('scope');
		var responseType = $.getUrlVar('response_type');
		var clientId = $.getUrlVar('client_id');
		var redirectURI = $.getUrlVar('redirect_uri');
		var requestOb = $.getUrlVar('request');
		var acrValues = $.getUrlVar('acr_values');
		var goTo = $.getUrlVar('goTo');

		window.parent.location = "intent://lock"
			+ "?redirect_uri=" + redirectURI
			+ "&request=" + requestOb
			+ "&state=" + state
			+ "&scope=" + scope
			+ "&response_type=" + responseType
			+ "&client_id=" + clientId
			+ "&acr_values=" + acrValues
			+ ((goTo === undefined) ? "" : "&goTo=" + goTo)
			+ "#Intent;scheme=rbcbankingskauth;package=com.rbc.mobile.android;end";
	},

	/**
	* Move to Play Store
	*
	* @method redirectPlayStore
	*/
	redirectPlayStore: function () {
		var platform = $.getUrlVar('platform');

		if (platform == "AN") {
			window.location = "https://play.google.com/store/apps/details?id=com.rbc.mobile.android";
		}
	},

	/**
	 * Display the appropriate app store image + link.
	 * 
	 * @method switchAppStoreImage
	 */
	switchAppStoreImage: function (lang, device) {
		if (device === "ip") {
			$("#app-store-link").prop("href", "https://itunes.apple.com/ca/app/rbc-mobile/id407597290?mt=8");
			
			$("#app-store-wrapper").attr("style", "display:block");
			if (lang === "fr") {
				$("#app-store-img").attr("src","../assets/images/ios-app-str-fr.svg");
				$("#app-store-img").attr("height", "40px");
			} else {
				$("#app-store-img").attr("src","../assets/images/ios-app-str-en.svg");
				$("#app-store-img").attr("height", "40px");
			}
		} else if (device === "an") {
			$("#app-store-link").prop("href", "https://play.google.com/store/apps/details?id=com.rbc.mobile.android");
			
			$("#app-store-wrapper").attr("style", "display:block");
			if (lang === "fr") {
				$("#app-store-img").attr("src","../assets/images/an-app-str-fr.png");
				$("#app-store-img").attr("height","40px");
			} else {
				$("#app-store-img").attr("src","../assets/images/an-app-str-en.png");
				$("#app-store-img").attr("height","40px");
			}
		} else {
			
			$("#app-store-wrapper").attr("style", "display:none");
		}
	},

	/**
	 * Shows the RBC mobile app link, unless the device is NOT Android/iOS
	 * 
	 * @method showMobileAppLink
	 */
	showMobileAppLink: function(device) {
		if (device === "ip" || device === "an") {
			$("#download-link").attr("style", "display:block");
		} else {
			$("#download-link").attr("style", "display:none");
		}
	},

	/**
	 * Detect the language used by the browser.
	 * 
	 * @method detectLanguage
	 */
	detectLanguage: function() {
		var userLanguage = $.getUrlVar('lang');

		if( !userLanguage ) {
			userLanguage = "en";
		}

		if (navigator.userLanguage) {
			userLanguage = navigator.userLanguage; // Internet Explorer
		}
		else if (navigator.language) {
			userLanguage = navigator.language;  // Firefox, Chrome
		}
	
		if (userLanguage.length > 2) {
			userLanguage = userLanguage.substring(0,2);
		}

		return userLanguage;
	},

	/**
	 * Returns the device with platform used 
	 *   ip - iOS
	 *   ipad - iOS PAD
	 *   an - Android
	 *   other - everything else
	 * 
	 * @method detectDevice
	 */
	detectDeviceByType: function(md) {
		var userDevice = "other";

		if (md.os() === 'iOS') {
			if(md.tablet() === 'iPad') {
				userDevice = "ipad";
			}
			else{
				userDevice = "ip";
			}
			
		}
		else if (md.os() === 'AndroidOS') {
			userDevice = "an";
		}

		return userDevice;
	},

	/**
	 * Returns the device used 
	 *   ip - iOS
	 *   an - Android
	 *   other - everything else
	 * 
	 * @method detectDevice
	 */
	detectDevice: function(md) {
		var userDevice = "other";
		if (md.os() === 'iOS' || md.tablet() === 'iPad') {
			userDevice = "ip";
		}
		else if (md.os() === 'AndroidOS') {
			userDevice = "an";
		}

		return userDevice;
	},
});
